// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

/// @title TrustVaultV2
/// @notice Identity registry + credential issuance, verification and revocation vault
/// @author
contract TrustVaultV2 {
    // ----------------------------
    // STRUCTS & ENUMS
    // ----------------------------
    enum CredentialState { Issued, Verified, Revoked }

    struct Credential {
        uint256 id;              // global credential id
        address subject;         // who the credential was issued to
        address issuer;          // who issued it
        string title;
        string description;
        uint256 timestamp;       // issued timestamp
        CredentialState state;
    }

    struct Identity {
        string name;
        string email;
        bool isRegistered;
    }

    // ----------------------------
    // STATE
    // ----------------------------
    address public owner;
    uint256 public totalUsers;
    uint256 private _nextCredentialId;

    // identities
    mapping(address => Identity) private identities;

    // credentials storage
    mapping(uint256 => Credential) private credentials;         // global id -> Credential
    mapping(address => uint256[]) private userCredentialIds;    // user -> list of credential ids
    mapping(address => uint256[]) private issuerCredentialIds;  // issuer -> list of credential ids

    // issuer registry
    mapping(address => bool) public verifiedIssuers;

    // ----------------------------
    // EVENTS
    // ----------------------------
    event IdentityRegistered(address indexed user, string name, string email);
    event IdentityUpdated(address indexed user, string name, string email);
    event IdentityDeregistered(address indexed user);
    event IssuerStatusUpdated(address indexed issuer, bool status);
    event CredentialIssued(uint256 indexed credentialId, address indexed subject, address indexed issuer, string title);
    event CredentialVerified(uint256 indexed credentialId, address indexed verifier);
    event CredentialRevoked(uint256 indexed credentialId, address indexed revokedBy);
    event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);

    // ----------------------------
    // MODIFIERS
    // ----------------------------
    modifier onlyOwner() {
        require(msg.sender == owner, "TrustVaultV2: only owner");
        _;
    }

    modifier onlyRegistered(address _user) {
        require(identities[_user].isRegistered, "TrustVaultV2: user not registered");
        _;
    }

    modifier onlyVerifiedIssuer() {
        require(verifiedIssuers[msg.sender], "TrustVaultV2: not a verified issuer");
        _;
    }

    modifier credentialExists(uint256 _credentialId) {
        require(credentials[_credentialId].id != 0, "TrustVaultV2: credential not found");
        _;
    }

    // ----------------------------
    // CONSTRUCTOR
    // ----------------------------
    constructor() {
        owner = msg.sender;
        _nextCredentialId = 1; // start ids at 1 for clarity
        // Optionally make deployer a verified issuer
        verifiedIssuers[msg.sender] = true;
    }

    // ----------------------------
    // IDENTITY FUNCTIONS
    // ----------------------------

    /// @notice Register the caller as an identity
    function registerIdentity(string calldata _name, string calldata _email) external {
        require(!identities[msg.sender].isRegistered, "TrustVaultV2: already registered");
        require(bytes(_name).length > 0, "TrustVaultV2: empty name");
        require(bytes(_email).length > 0, "TrustVaultV2: empty email");

        identities[msg.sender] = Identity({ name: _name, email: _email, isRegistered: true });
        totalUsers += 1;

        emit IdentityRegistered(msg.sender, _name, _email);
    }

    /// @notice Update name/email for caller
    function updateIdentity(string calldata _name, string calldata _email) external onlyRegistered(msg.sender) {
        require(bytes(_name).length > 0, "TrustVaultV2: empty name");
        require(bytes(_email).length > 0, "TrustVaultV2: empty email");

        identities[msg.sender].name = _name;
        identities[msg.sender].email = _email;

        emit IdentityUpdated(msg.sender, _name, _email);
    }

    /// @notice Deregister the caller (cannot remove credentials)
    function deregisterIdentity() external onlyRegistered(msg.sender) {
        identities[msg.sender].isRegistered = false;
        totalUsers -= 1;
        emit IdentityDeregistered(msg.sender);
    }

    // ----------------------------
    // ISSUER ADMIN
    // ----------------------------

    /// @notice Add or remove a verified issuer
    function updateVerifiedIssuer(address _issuer, bool _status) external onlyOwner {
        require(_issuer != address(0), "TrustVaultV2: zero address");
        require(verifiedIssuers[_issuer] != _status, "TrustVaultV2: no change");
        verifiedIssuers[_issuer] = _status;
        emit IssuerStatusUpdated(_issuer, _status);
    }

    /// @notice Transfer ownership
    function transferOwnership(address _newOwner) external onlyOwner {
        require(_newOwner != address(0), "TrustVaultV2: zero address");
        address previousOwner = owner;
        owner = _newOwner;
        emit OwnershipTransferred(previousOwner, _newOwner);
    }

    /// @notice Renounce ownership (irreversible)
    function renounceOwnership() external onlyOwner {
        address previousOwner = owner;
        owner = address(0);
        emit OwnershipTransferred(previousOwner, address(0));
    }

    // ----------------------------
    // CREDENTIAL LIFECYCLE
    // ----------------------------

    /// @notice Issue a credential to a registered user. Caller must be a verified issuer.
    /// @dev Issued credentials start in state `Issued` and may be verified later.
    function issueCredential(
        address _subject,
        string calldata _title,
        string calldata _description
    ) external onlyVerifiedIssuer onlyRegistered(_subject) returns (uint256) {
        require(bytes(_title).length > 0, "TrustVaultV2: empty title");

        uint256 cid = _nextCredentialId++;
        Credential memory cred = Credential({
            id: cid,
            subject: _subject,
            issuer: msg.sender,
            title: _title,
            description: _description,
            timestamp: block.timestamp,
            state: CredentialState.Issued
        });

        credentials[cid] = cred;
        userCredentialIds[_subject].push(cid);
        issuerCredentialIds[msg.sender].push(cid);

        emit CredentialIssued(cid, _subject, msg.sender, _title);
        return cid;
    }

    /// @notice Mark an issued credential as Verified. Caller must be a verified issuer.
    /// @dev Only credentials in state Issued can be verified.
    function verifyCredential(uint256 _credentialId) external onlyVerifiedIssuer credentialExists(_credentialId) {
        Credential storage cred = credentials[_credentialId];
        require(cred.state == CredentialState.Issued, "TrustVaultV2: not in issued state");

        cred.state = CredentialState.Verified;
        emit CredentialVerified(_credentialId, msg.sender);
    }

    /// @notice Revoke a credential. Can be called by credential issuer or contract owner.
    function revokeCredential(uint256 _credentialId) external credentialExists(_credentialId) {
        Credential storage cred = credentials[_credentialId];
        require(cred.state != CredentialState.Revoked, "TrustVaultV2: already revoked");
        require(msg.sender == cred.issuer || msg.sender == owner, "TrustVaultV2: not authorized to revoke");

        cred.state = CredentialState.Revoked;
        emit CredentialRevoked(_credentialId, msg.sender);
    }

    // ----------------------------
    // VIEW / GETTERS
    // ----------------------------

    /// @notice Get a credential by global id
    function getCredential(uint256 _credentialId)
        external
        view
        credentialExists(_credentialId)
        returns (
            uint256 id,
            address subject,
            address issuer,
            string memory title,
            string memory description,
            uint256 timestamp,
            CredentialState state
        )
    {
        Credential memory cred = credentials[_credentialId];
        return (cred.id, cred.subject, cred.issuer, cred.title, cred.description, cred.timestamp, cred.state);
    }

    /// @notice Get number of credentials a user has (including revoked)
    function getUserCredentialCount(address _user) external view returns (uint256) {
        return userCredentialIds[_user].length;
    }

    /// @notice Get user's credential id at index (useful for enumeration)
    function getUserCredentialIdAt(address _user, uint256 _index) external view returns (uint256) {
        require(_index < userCredentialIds[_user].length, "TrustVaultV2: index OOB");
        return userCredentialIds[_user][_index];
    }

    /// @notice Get all credential ids for a user
    function getUserCredentials(address _user) external view returns (uint256[] memory) {
        return userCredentialIds[_user];
    }

    /// @notice Get number of credentials an issuer has issued
    function getIssuerCredentialCount(address _issuer) external view returns (uint256) {
        return issuerCredentialIds[_issuer].length;
    }

    /// @notice Get all credential ids issued by an issuer
    function getIssuerCredentials(address _issuer) external view returns (uint256[] memory) {
        return issuerCredentialIds[_issuer];
    }

    /// @notice Get identity info
    function getIdentity(address _user)
        external
        view
        returns (string memory name, string memory email, bool registered)
    {
        Identity memory id = identities[_user];
        return (id.name, id.email, id.isRegistered);
    }

    /// @notice Check whether an address is a verified issuer
    function isVerifiedIssuer(address _addr) external view returns (bool) {
        return verifiedIssuers[_addr];
    }

    /// @notice Returns the total number of credentials ever issued (including revoked).
    function totalCredentials() external view returns (uint256) {
        return _nextCredentialId - 1;
    }
}

